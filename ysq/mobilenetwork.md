## 移动网络速度粗略研究@v1

### 传统CDN网络

随着公司战略的逐步转移到移动端，各种打不开，打开慢，白屏，闪退的问题就接踵而至了。原来在web端好好的网页，为什么到了手机上就慢的如此不堪忍受？这个问题必须解决，还得尽快。

我们熟悉的、传统的CDN如下：

![CDN](https://github.com/yangshiqi/wiki/blob/master/imgs/cdn_overview.gif)

用户根据所在运营商网络（比如北联通，南电信），发起HTTP请求。CDN会根据用户所在网络，就近去将他路由到同运营商网络中的节点。如图，联通用户在访问好大夫在线时，根据DNS原则，发现其请求来自广东电信，此时，CDN网络会优先将他发起的HTTP请求发送到广东电信机房，来尝试响应其所需要的资源（如html静态页，图片，css等），如果北京联通机房有这个资源文件，则立即返回给用户，请求结束。如果没有，则根据网站配置的规则，返回好大夫在线位于北京的IDC多线机房，取回相关的内容，然后按照原路返回到广东电信机房，缓存这个内容，再返回给广东的那个用户。比如用户使用的是ADSL，我们假设他访问DNS是5ms，访问电信机房的握手时间是10ms，传输时间是500ms（取决于用户的网速），那么总共加起来时间5ms+10ms+500ms+10ms=525ms。而如果回源取内容的话，假设是从广东电信到北京电信，传输需要50ms+10ms+10ms（假设运营商之间有光纤直连，传输1M数据只需要10ms，访问好大夫服务器只需要10ms，电信之间链路需要50ms）=70ms，则加上之前的近535ms。

所以，当用户访问的资源文件就近命中CDN的越多，用户需要等待的时间越短，感受越好。

但是，如果同样的模型放到移动网络中，虽然大体上的结构还是一样的，但是用户端的接入和运营商网络间的传输问题，就成了额外的问题，而这些，也是我们考虑移动产品特性所需要的。


### 移动网络

简单网络图：

![mobile](https://github.com/yangshiqi/wiki/blob/master/imgs/mobilecdn.png)

>注： Last-mile 最后一公里，通信行业经常使用“最后一公里”来指代从通信服务提供商的机房交换机到用户计算机等终端设备之间的连接。

而借用之前 @韩宇斌 同学讲解过的移动网络传输的知识，用户在移动过程中，其数据连接是在不断发生着握手，选择，切换基站等等，还有每次通信中移动网络的安全传输问题。

手机要通过无线网络协议，从基站获得无线链路分配，才能跟网络进行通讯。
获得无线链路后，在连通后还要判断你是否开通套餐，是不是漫游等，是不是要回源计费等等。
之后，核心网络才会给你进行APN选择、IP分配、启动计费。

这都完事儿，才是我们知道的传统网络的步骤：DNS查询、响应，建立TCP链接，HTTP GET，RTTP RESPONSE 200 OK，HTTP RESPONSE DATA，LAST HTTP RESPONSE DATA，开始UI展现。

每个基站可用资源是非常有限的，连接一旦被建立，根据资源情况、用户链接活跃决定分配还是回收，来尽快帮你释放连接资源以给其他人使用。

连接部分请参考 @韩宇斌 同学的ppt，很清楚。

以上这些，都会造成移动网络下，每一次连接的珍贵，其开销甚至大于传统网络数据传输的总和！

再回到网络问题。用户比如从广东移动的网络，想要访问我们好大夫在线。此时，他需要“历经万难”的连入所在基站，透过广东移动网络，根据广东移动机房的策略，选择路由到我们位于北京的IDC机房，当然，如果我们刚好有移动网络接入会好些，如果只有联通和电信。。。就只能呵呵了。ok，即便有了和移动网络的接入，那么，也需要从广东移动回到北京移动，再通过北京移动的网络策略，选择到专线接入我们的IDC机房。此时，如果中间还夹杂着CDN网络回源问题，又变成了广东移动先要在其内部找到CDN位于广东的移动机房，然后在通过CDN网络传回北京移动，再到我们的机房。此时，终于找到内容了，ok，数据原路返回，然后再通过移动网络传回给用户手机。此时，如果用户处于基站选择切换过程中，或者刚好无信号，那么就只能等待用户手机客户端超时应答，然后服务器再断开连接了。

国内的现状是，各级ISP起码有几十家吧，大大小小的城市，运营商之间是不会考虑连通性问题的，他们都希望用户在自己的大网中，连通性好的话，岂不是可以让我们自由选择？

当然，如果中国移动，联通，电信自身搞CDN建设，那么我相信对于移动端的CDN加速来说，一定会有很大提升。目前，中国移动已经在自建CDN服务了，而联通和电信现在是和各大厂商在合作。


### 其它公司的做法

我听过淘宝和腾讯的分享，最牛的直接搞定当地运营商，给他们的客户端提高信令级别，优先保证他们服务的可用性。比如我们去某些2G网络都很差的地方，只能勉强用微信。。。

这里摘抄一段腾讯的做法，我个人认为腾讯这么多年来一直在手Q中是做的最好，技术最领先的：

---

给一个手机分配无线信道的信令又有好几个情况，比如基站跟手机，基站跟基站控制器、核心网。举个例子，服务器从后台发送push消息，移动网络可能不知道这个手机是否活跃，不知道在哪个小区，移动网络就会发一个寻呼，在各个小区找这个手机，当然这个不能基于IP，而是其他的网络标识。找到了之后，这个手机再去申请信道资源，然后才能接受push。所以，这种场景下信令的消耗可能会在很多小区产生。

根据以上情况，就形成无线网络的一大特点：秒级状态管理，秒级状态转换。这两个操作都在几百ms到几秒之间进行，对于维持连接来说时间太短，对于从无连接到有连接的转换来说时间又太长。

相比之下，有线网络的状态管理如ip分配、tcp连接释放，都是分钟级，而状态转换则是毫秒级。

这些通讯机制，同时加上无线网络的高延迟、高丢包。如何保证移动互联网的产品提供稳定的、可预期的服务质量，成为非常大的挑战：

2G网络上无线部分数据传输的延迟有几百ms，4G网络上无线部分传输延迟减少到几十ms，核心网状态转换、协议转换30~100ms，IP骨干网上的延迟又跟物理距离以及运营商互联互通质量有关，跨运营商50-400ms，同运营商5-80ms，这个还要取决于网络拥塞的情况。
无线网络误码率比有线高两个数量级，在不同时间段的波动也非常巨大。
怎么基于移动网络的特性去优化服务？这就是我们总结的一秒钟法则：在一秒内要完成的规定动作。

2g网络：1秒内完成dns查询、和后台服务器建立连接
3g网络：1秒内完成首字显示（首字时间）
wifi网络：1秒内完成首屏显示（首屏时间）
这些指标需要在终端度量，必须跟用户体验相关：首字时间、首屏时间都必须是用户可以直观感受到的。


---


其思路是从接入层，协议等技术手段上优化，目前BAT都在http2.0协议中探索各自的模式，其核心思想是利用google提出的SPDY协议，减少连接的开销。同时尽可能做简化，压缩，并发控制，减少连接，复用连接等等。

另外，也从业务上去思考基于移动网络的业务逻辑。比如在网络好的时候给用户高清图，不好的时候给缩略图，2G下给文字版等等。简化用户操作流程，使交互尽可能减少，最小化加载内容等。

无论多么高大上的手机app或者wap版，如果打不开，功能再强大、图片再清晰也不会有人用的。



参考：

* [网宿科技](http://www.chinanetcenter.com/)
* [
一秒钟法则：来自腾讯无线研发的经验分享](http://www.infoq.com/cn/articles/1sec-rule-from-tencent)